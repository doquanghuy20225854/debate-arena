generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER
  SELLER
  ADMIN
  CS
}

enum SellerKycStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ShopStatus {
  PENDING
  ACTIVE
  SUSPENDED
  HIDDEN
  BANNED
  REJECTED
}

enum ShopReportResolution {
  PENDING
  VALID
  INVALID
  ABUSIVE
  DUPLICATE
}

enum ShopReportSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ShopModerationActionType {
  WARN_1
  WARN_2
  WARN_3
  SUSPEND_7D
  SUSPEND_30D
  HIDE
  UNHIDE
  BAN
  UNBAN
  ADJUST_POINTS
}

enum ShopReportStatus {
  OPEN
  RESOLVED
  DISMISSED
}

enum ProductStatus {
  DRAFT
  ACTIVE
  HIDDEN
  BANNED
}

enum SKUStatus {
  ACTIVE
  HIDDEN
}

enum VoucherType {
  PERCENT
  FIXED
}

enum OrderStatus {
  PENDING_PAYMENT
  PLACED
  CONFIRMED
  PACKING
  SHIPPED
  DELIVERED
  COMPLETED
  CANCEL_REQUESTED
  CANCELLED
  RETURN_REQUESTED
  RETURN_APPROVED
  RETURN_REJECTED
  RETURN_RECEIVED
  REFUND_REQUESTED
  REFUNDED
  DISPUTED
}

enum PaymentMethod {
  COD
  BANK_TRANSFER
  MOCK_GATEWAY
}

enum PaymentStatus {
  UNPAID
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
}

enum ShipmentStatus {
  PENDING
  READY_TO_SHIP
  SHIPPED
  IN_TRANSIT
  DELIVERED
  RETURNED
}

enum RequestStatus {
  REQUESTED
  APPROVED
  REJECTED
}

enum ReturnStatus {
  REQUESTED
  APPROVED
  REJECTED
  RECEIVED
  CLOSED
}

enum RefundStatus {
  REQUESTED
  APPROVED
  REJECTED
  PROCESSING
  SUCCESS
  FAILED
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED
  REJECTED
}

enum ReviewStatus {
  VISIBLE
  HIDDEN
}

enum ReviewReportStatus {
  OPEN
  RESOLVED
}

enum ShopAddressType {
  PICKUP
  RETURN
}

enum CheckoutDraftStatus {
  DRAFT
  COMMITTED
  EXPIRED
  CANCELLED
}

enum IdempotencyStatus {
  IN_PROGRESS
  SUCCESS
  FAILED
}

enum ShopMemberRole {
  OWNER
  MANAGER
  STAFF
}

enum ShopMemberStatus {
  ACTIVE
  INVITED
  DISABLED
}

enum PayoutStatus {
  REQUESTED
  APPROVED
  REJECTED
  PAID
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  username  String   @unique
  name      String?
  phone     String?
  avatarUrl String?
  password  String
  role      UserRole @default(CUSTOMER)
  isBlocked Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  addresses    Address[]
  cart         Cart?
  wishlist     WishlistItem[]
  orders       Order[]
  reviews      Review[]
  sellerProfile SellerProfile?
  shop         Shop?
  notifications Notification[]
  auditLogs    AuditLog[] @relation("AuditActor")
  messages     ChatMessage[] @relation("ChatSender")
  disputes     Dispute[]
  reviewReports ReviewReport[] @relation("ReviewReportsByUser")

  // Review follow-up thread (Shopee-like)
  reviewBuyerFollowUps ReviewBuyerFollowUp[]

  // Shop reports
  reportedShopReports ShopReport[] @relation("ShopReportReporter")
  resolvedShopReports ShopReport[] @relation("ShopReportResolvedBy")

  shopModerationEvents ShopModerationEvent[] @relation("ShopModerationActor")

  cancelRequests CancelRequest[] @relation("CancelRequestedBy")
  returnRequests ReturnRequest[] @relation("ReturnRequestedBy")

  cancelResolved CancelRequest[] @relation("CancelResolvedBy")
  returnResolved ReturnRequest[] @relation("ReturnResolvedBy")
  disputeResolved Dispute[] @relation("DisputeResolvedBy")
  disputeRevisionRequested Dispute[] @relation("DisputeRevisionRequestedBy")
  refundProcessed Refund[] @relation("RefundProcessedBy")

  checkoutDrafts CheckoutDraft[]
  idempotencyKeys IdempotencyKey[]
  shopMemberships ShopMember[]
  payoutRequests Payout[] @relation("PayoutRequestedBy")
  payoutProcessed Payout[] @relation("PayoutProcessedBy")

  passwordResets PasswordResetToken[]
}

model Address {
  id         Int      @id @default(autoincrement())
  userId     Int
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  fullName   String
  phone      String
  line1      String
  line2      String?
  ward       String?
  district   String?
  city       String?
  province   String?
  country    String   @default("VN")
  postalCode String?
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@index([userId])
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([userId])
}

model SellerProfile {
  id             Int             @id @default(autoincrement())
  userId         Int             @unique
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  status         SellerKycStatus @default(PENDING)
  shopName       String
  phone          String?
  taxId          String?
  kycDocumentUrl String?
  rejectedReason String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime @default(now()) @updatedAt
}

model Shop {
  id          Int        @id @default(autoincrement())
  ownerId     Int        @unique
  owner       User       @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  name        String
  slug        String     @unique
  description String?
  logoUrl     String?
  status      ShopStatus @default(PENDING)
  moderationNote String?
  suspendedAt DateTime?
  suspensionUntil DateTime?
  bannedAt    DateTime?

  // Moderation & policy
  violationPoints Int @default(0)
  warningLevel    Int @default(0) // 0..3
  strikes         Int @default(0) // 0..3 (>=3 => BAN)
  lastModeratedAt DateTime?
  ratingAvg   Float      @default(0)
  ratingCount Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @default(now()) @updatedAt

  products        Product[]
  orders          Order[]
  reviews         Review[]
  shopAddresses   ShopAddress[]
  shippingConfigs ShippingConfig[]
  payoutAccount   PayoutAccount?
  reviewReplies   ReviewReply[]
  // Review follow-up thread (Shopee-like)
  reviewSellerFollowUps ReviewSellerFollowUp[]
  members         ShopMember[]
  shopVouchers    ShopVoucher[]
  payouts         Payout[]
  draftGroups     CheckoutDraftGroup[]
  draftItems      CheckoutDraftItem[]

  reports         ShopReport[]
  moderationEvents ShopModerationEvent[]
}

model ShopModerationEvent {
  id        Int  @id @default(autoincrement())
  shopId    Int
  shop      Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  actorId   Int?
  actor     User? @relation("ShopModerationActor", fields: [actorId], references: [id], onDelete: SetNull)

  action    ShopModerationActionType
  pointsDelta Int @default(0)
  note      String? @db.Text
  meta      Json?
  createdAt DateTime @default(now())

  @@index([shopId])
  @@index([action])
  @@index([createdAt])
}

model ShopAddress {
  id         Int            @id @default(autoincrement())
  shopId     Int
  shop       Shop           @relation(fields: [shopId], references: [id], onDelete: Cascade)
  type       ShopAddressType @default(PICKUP)
  fullName   String?
  phone      String?
  line1      String
  line2      String?
  ward       String?
  district   String?
  city       String?
  province   String?
  country    String         @default("VN")
  postalCode String?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@index([shopId])
}

model ShippingConfig {
  id        Int      @id @default(autoincrement())
  shopId    Int
  shop      Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  // Carrier / method
  carrier     String
  code        String
  serviceName String
  description String?
  isActive    Boolean  @default(true)

  // Pricing (VND)
  baseFee          Int @default(0)
  feePerItem       Int @default(0)
  feePerKg         Int @default(0)
  freeShippingOver Int?

  // ETA & constraints
  minDays       Int @default(2)
  maxDays       Int @default(4)
  maxWeightGram Int?
  codSupported  Boolean @default(true)

  // Zone constraints: JSON array of { province?, city?, district? }
  zonesJson String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  draftGroups CheckoutDraftGroup[]

  @@unique([shopId, code])
  @@index([shopId])
  @@index([isActive])
  @@index([carrier])
}


model IdempotencyKey {
  id          Int               @id @default(autoincrement())
  userId      Int
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  scope       String
  key         String
  requestHash String
  status      IdempotencyStatus @default(IN_PROGRESS)
  httpStatus  Int?
  responseJson String?
  errorJson   String?
  expiresAt   DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @default(now()) @updatedAt

  @@unique([userId, scope, key])
  @@index([userId])
  @@index([scope])
  @@index([expiresAt])
}

model CheckoutDraft {
  id            Int               @id @default(autoincrement())
  code          String            @unique
  userId        Int
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  status        CheckoutDraftStatus @default(DRAFT)
  currency      String            @default("VND")
  subtotal      Int               @default(0)
  shippingTotal Int               @default(0)
  discountTotal Int               @default(0)
  total         Int               @default(0)
  note          String?
  voucherId     Int?
  voucher       Voucher?          @relation(fields: [voucherId], references: [id], onDelete: SetNull)
  voucherCode   String?

  shipFullName   String
  shipPhone      String
  shipLine1      String
  shipLine2      String?
  shipWard       String?
  shipDistrict   String?
  shipCity       String?
  shipProvince   String?
  shipCountry    String           @default("VN")
  shipPostalCode String?

  expiresAt   DateTime?
  committedAt DateTime?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @default(now()) @updatedAt

  groups CheckoutDraftGroup[]
  items  CheckoutDraftItem[]

  @@index([userId])
  @@index([status])
  @@index([expiresAt])
}

model CheckoutDraftGroup {
  id        Int          @id @default(autoincrement())
  draftId   Int
  draft     CheckoutDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)
  shopId    Int
  shop      Shop         @relation(fields: [shopId], references: [id], onDelete: Cascade)

  subtotal     Int @default(0)
  shippingFee  Int @default(0)
  // Platform voucher share for this shop-group (computed from CheckoutDraft.voucherCode/voucherId).
  discount     Int @default(0)
  // Shop voucher discount for this shop-group.
  shopDiscount Int @default(0)
  total        Int @default(0)

  shopVoucherId Int?
  shopVoucher   ShopVoucher? @relation(fields: [shopVoucherId], references: [id], onDelete: SetNull)

  shippingConfigId Int?
  shippingConfig   ShippingConfig? @relation(fields: [shippingConfigId], references: [id], onDelete: SetNull)
  shippingCarrier  String?
  shippingServiceName String?
  shippingOptionCode String?
  etaMinDays Int?
  etaMaxDays Int?

  errorCode    String?
  errorMessage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  items CheckoutDraftItem[]

  @@unique([draftId, shopId])
  @@index([draftId])
  @@index([shopId])
}

model CheckoutDraftItem {
  id        Int      @id @default(autoincrement())
  draftId   Int
  draft     CheckoutDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)
  groupId   Int
  group     CheckoutDraftGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  shopId    Int
  shop      Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  skuId     Int
  sku       SKU      @relation(fields: [skuId], references: [id])
  productId Int
  product   Product  @relation(fields: [productId], references: [id])

  name      String
  unitPrice Int
  // Snapshot SKU cost price at draft time for profit calculation.
  costPrice Int?
  qty       Int
  weightGram Int?
  lineTotal Int

  createdAt DateTime @default(now())

  @@index([draftId])
  @@index([groupId])
  @@index([shopId])
  @@index([skuId])
}

model ShopMember {
  id        Int            @id @default(autoincrement())
  shopId    Int
  shop      Shop           @relation(fields: [shopId], references: [id], onDelete: Cascade)
  userId    Int
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      ShopMemberRole @default(STAFF)
  status    ShopMemberStatus @default(ACTIVE)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @default(now()) @updatedAt

  @@unique([shopId, userId])
  @@index([shopId])
  @@index([userId])
  @@index([role])
}

model ShopVoucher {
  id          Int         @id @default(autoincrement())
  shopId      Int
  shop        Shop        @relation(fields: [shopId], references: [id], onDelete: Cascade)
  code        String      @unique
  type        VoucherType
  value       Int
  minSubtotal Int         @default(0)
  maxDiscount Int?
  // Loyalty conditions (optional): require buyer spend with this shop in current month/year.
  // 0 means no restriction.
  minBuyerSpendMonth Int  @default(0)
  minBuyerSpendYear  Int  @default(0)
  startAt     DateTime?
  endAt       DateTime?
  usageLimit  Int?
  usedCount   Int         @default(0)
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @default(now()) @updatedAt
  draftGroups CheckoutDraftGroup[]

  orders Order[]

  @@index([shopId])
  @@index([isActive])
}

model Payout {
  id             Int         @id @default(autoincrement())
  shopId         Int
  shop           Shop        @relation(fields: [shopId], references: [id], onDelete: Cascade)
  amount         Int
  currency       String      @default("VND")
  status         PayoutStatus @default(REQUESTED)
  note           String?
  requestedById  Int
  requestedBy    User        @relation("PayoutRequestedBy", fields: [requestedById], references: [id])
  processedById  Int?
  processedBy    User?       @relation("PayoutProcessedBy", fields: [processedById], references: [id])
  processedAt    DateTime?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @default(now()) @updatedAt

  @@index([shopId])
  @@index([status])
  @@index([requestedById])
}

model PayoutAccount {
  id                Int      @id @default(autoincrement())
  shopId            Int      @unique
  shop              Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  bankName          String?
  bankAccountName   String?
  bankAccountNumber String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now()) @updatedAt
}

model Category {
  id        Int      @id @default(autoincrement())
  name      String
  slug      String   @unique
  parentId  Int?
  parent    Category? @relation("CategoryParent", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryParent")
  products  Product[]
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([parentId])
}

model Product {
  id            Int           @id @default(autoincrement())
  shopId        Int
  shop          Shop          @relation(fields: [shopId], references: [id], onDelete: Cascade)
  categoryId    Int?
  category      Category?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  name          String
  slug          String        @unique
  description   String?
  status        ProductStatus @default(ACTIVE)
  price         Int
  compareAtPrice Int?
  thumbnailUrl  String?
  ratingAvg     Float         @default(0)
  ratingCount   Int           @default(0)
  soldCount     Int           @default(0)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  images     ProductImage[]
  skus       SKU[]
  wishlist   WishlistItem[]
  orderItems OrderItem[]
  reviews    Review[]
  draftItems CheckoutDraftItem[]

  @@index([shopId])
  @@index([categoryId])
  @@index([status])
  @@index([ratingAvg])
  @@index([soldCount])
}

model ProductImage {
  id        Int     @id @default(autoincrement())
  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  url       String
  sortOrder Int     @default(0)
}

model SKU {
  id             Int       @id @default(autoincrement())
  productId       Int
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  skuCode         String   @unique
  name            String
  attributesJson  String?
  price           Int?
  // Cost price (COGS) for profit calculation. Snapshot into OrderItem on checkout.
  costPrice       Int?
  compareAtPrice  Int?
  stock           Int      @default(0)
  weightGram      Int?
  status          SKUStatus @default(ACTIVE)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt

  cartItems  CartItem[]
  orderItems OrderItem[]
  draftItems CheckoutDraftItem[]

  @@index([productId])
}

model WishlistItem {
  id        Int      @id @default(autoincrement())
  userId    Int
  productId Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
}

model Cart {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model CartItem {
  id        Int      @id @default(autoincrement())
  cartId    Int
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  skuId     Int
  sku       SKU      @relation(fields: [skuId], references: [id], onDelete: Cascade)
  qty       Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([cartId, skuId])
  @@index([cartId])
  @@index([skuId])
}

model Voucher {
  id          Int         @id @default(autoincrement())
  code        String      @unique
  type        VoucherType
  value       Int
  minSubtotal Int         @default(0)
  maxDiscount Int?
  // Loyalty conditions (optional): require buyer spend (gross) in current month/year.
  // 0 means no restriction.
  minBuyerSpendMonth Int  @default(0)
  minBuyerSpendYear  Int  @default(0)
  startAt     DateTime?
  endAt       DateTime?
  usageLimit  Int?
  usedCount   Int         @default(0)
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  checkoutDrafts CheckoutDraft[]

  orders Order[]
}

model Order {
  id           Int        @id @default(autoincrement())
  code         String     @unique
  groupCode    String?
  userId       Int
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  shopId       Int
  shop         Shop       @relation(fields: [shopId], references: [id], onDelete: Cascade)
  status       OrderStatus @default(PLACED)

  subtotal     Int
  shippingFee  Int        @default(0)
  discount     Int        @default(0)
  total        Int
  currency     String     @default("VND")
  note         String?

  // Selected shipping option snapshot
  shippingCarrier     String?
  shippingServiceName String?
  shippingOptionCode  String?
  shippingEtaMinDays  Int?
  shippingEtaMaxDays  Int?

  shipFullName String
  shipPhone    String
  shipLine1    String
  shipLine2    String?
  shipWard     String?
  shipDistrict String?
  shipCity     String?
  shipProvince String?
  shipCountry  String     @default("VN")
  shipPostalCode String?

  voucherId Int?
  voucher   Voucher? @relation(fields: [voucherId], references: [id], onDelete: SetNull)

  shopVoucherId Int?
  shopVoucher   ShopVoucher? @relation(fields: [shopVoucherId], references: [id], onDelete: SetNull)

  items               OrderItem[]
  paymentTransactions Payment[]
  shipment            Shipment?
  cancelRequest       CancelRequest?
  returnRequest       ReturnRequest?
  refund              Refund?
  dispute             Dispute?
  thread              ChatThread?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([userId])
  @@index([shopId])
  @@index([status])
  @@index([createdAt])
  @@index([groupCode])
  @@index([shopVoucherId])
}

model OrderItem {
  id        Int      @id @default(autoincrement())
  orderId   Int
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId Int
  product   Product  @relation(fields: [productId], references: [id])
  skuId     Int
  sku       SKU      @relation(fields: [skuId], references: [id])
  name      String
  unitPrice Int
  // Snapshot SKU cost price (COGS) at the time of order.
  costPrice Int?
  qty       Int
  lineTotal Int
  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([productId])
  @@index([skuId])
}

model Payment {
  id         Int          @id @default(autoincrement())
  orderId    Int
  order      Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  method     PaymentMethod
  status     PaymentStatus @default(UNPAID)
  amount     Int
  provider   String?
  providerRef String?
  paidAt     DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@index([orderId])
  @@index([status])
}

model Shipment {
  id          Int          @id @default(autoincrement())
  orderId     Int          @unique
  order       Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  carrier     String       @default("MOCK")
  trackingCode String?     @unique
  status      ShipmentStatus @default(PENDING)
  shippedAt   DateTime?
  deliveredAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  events ShipmentEvent[]
}

model ShipmentEvent {
  id         Int          @id @default(autoincrement())
  shipmentId Int
  shipment   Shipment     @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  status     ShipmentStatus
  message    String?
  location   String?
  createdAt  DateTime @default(now())

  @@index([shipmentId])
}

model CancelRequest {
  id           Int          @id @default(autoincrement())
  orderId      Int          @unique
  order        Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  userId       Int
  user         User         @relation("CancelRequestedBy", fields: [userId], references: [id], onDelete: Cascade)
  /// Order status at the time buyer requested cancellation.
  /// Used to restore order status if seller rejects the request.
  originalStatus OrderStatus @default(CONFIRMED)
  reason       String
  status       RequestStatus @default(REQUESTED)
  resolvedById Int?
  resolvedBy   User?        @relation("CancelResolvedBy", fields: [resolvedById], references: [id])
  resolvedAt   DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  @@index([userId])
  @@index([status])
}

model ReturnRequest {
  id             Int          @id @default(autoincrement())
  orderId        Int          @unique
  order          Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  userId         Int
  user           User         @relation("ReturnRequestedBy", fields: [userId], references: [id], onDelete: Cascade)
  reason         String
  /// Optional: classify the request so policies can be applied.
  /// Example values: CHANGE_MIND, DEFECTIVE, WRONG_ITEM, NOT_AS_DESCRIBED, OTHER
  requestType    String?
  status         ReturnStatus @default(REQUESTED)
  evidenceUrlsJson String?
  /// Seller decision / policy fields (to avoid seller loss for abusive returns)
  /// resolution: BUYER_FAULT | SELLER_FAULT
  resolution     String?
  /// shippingPayer: BUYER | SELLER
  shippingPayer  String?
  /// Restocking fee (VND) - deducted from refund when BUYER_FAULT.
  restockingFee  Int?
  /// Refund amount (VND). If null, system will compute.
  refundAmount   Int?
  /// Seller note / decision note.
  decisionNote   String?
  resolvedById   Int?
  resolvedBy     User?        @relation("ReturnResolvedBy", fields: [resolvedById], references: [id])
  resolvedAt     DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @default(now()) @updatedAt

  @@index([userId])
  @@index([status])
}

model Refund {
  id            Int          @id @default(autoincrement())
  orderId       Int          @unique
  order         Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  amount        Int
  reason        String?
  status        RefundStatus @default(REQUESTED)
  processedById Int?
  processedBy   User?        @relation("RefundProcessedBy", fields: [processedById], references: [id])
  provider      String?
  providerRef   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  @@index([status])
}

model Dispute {
  id            Int          @id @default(autoincrement())
  orderId       Int          @unique
  order         Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  userId        Int
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  type          String?
  message       String
  /// Evidence images uploaded by customer (array of public URLs, stored as JSON string)
  mediaUrlsJson String? @db.Text
  sellerResponse String? @db.Text
  sellerRespondedAt DateTime?
  status        DisputeStatus @default(OPEN)
  resolution    String?
  resolvedById  Int?
  resolvedBy    User?        @relation("DisputeResolvedBy", fields: [resolvedById], references: [id])
  resolvedAt    DateTime?

  /// Request to revise admin decision (only allow one revision)
  revisionRequestedAt   DateTime?
  revisionRequestedById Int?
  revisionRequestedBy   User?        @relation("DisputeRevisionRequestedBy", fields: [revisionRequestedById], references: [id], onDelete: SetNull)
  revisionRequestedByRole String?
  revisionRequestNote   String? @db.Text
  /// Admin can edit resolution only once if a revision request exists
  editCount Int @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  @@index([status])
}

model ChatThread {
  id        Int      @id @default(autoincrement())
  orderId   Int      @unique
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  messages  ChatMessage[]
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model ChatMessage {
  id        Int      @id @default(autoincrement())
  threadId  Int
  thread    ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  senderId  Int
  sender    User     @relation("ChatSender", fields: [senderId], references: [id], onDelete: Cascade)
  message   String
  createdAt DateTime @default(now())

  @@index([threadId])
  @@index([senderId])
}

model Review {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId Int?
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  shopId    Int?
  shop      Shop?    @relation(fields: [shopId], references: [id], onDelete: Cascade)
  rating    Int
  content   String? @db.Text
  /// Buyer can edit rating/content only once.
  editCount Int @default(0)
  mediaUrlsJson String? @db.Text
  status    ReviewStatus @default(VISIBLE)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  reports ReviewReport[]
  replies ReviewReply[]
  buyerFollowUp ReviewBuyerFollowUp?
  sellerFollowUp ReviewSellerFollowUp?

  @@index([productId])
  @@index([shopId])
  @@index([status])
  @@unique([userId, productId])
  @@index([userId, shopId])
}

model ReviewReply {
  id        Int      @id @default(autoincrement())
  reviewId  Int
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  shopId    Int
  shop      Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  content   String @db.Text
  /// Seller can edit reply only once.
  editCount Int @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([reviewId])
  @@index([shopId])
  @@unique([reviewId, shopId])
}

/// Optional follow-up message from buyer after seller replied.
/// One follow-up per review to keep the thread simple (Shopee-like).
model ReviewBuyerFollowUp {
  id        Int      @id @default(autoincrement())
  reviewId  Int      @unique
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content   String @db.Text
  createdAt DateTime @default(now())

  @@index([userId])
}

/// Optional follow-up from seller after buyer follow-up.
model ReviewSellerFollowUp {
  id        Int      @id @default(autoincrement())
  reviewId  Int      @unique
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  shopId    Int
  shop      Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  content   String @db.Text
  createdAt DateTime @default(now())

  @@index([shopId])
}

model ShopReport {
  id          Int             @id @default(autoincrement())
  shopId      Int
  shop        Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)

  reporterId  Int
  reporter    User            @relation("ShopReportReporter", fields: [reporterId], references: [id], onDelete: Cascade)

  reason      String
  description String?         @db.Text
  status      ShopReportStatus @default(OPEN)

  // Classification & anti-abuse
  category    String? // e.g. FRAUD, COUNTERFEIT, SERVICE, POLICY
  severity    ShopReportSeverity @default(LOW)
  isVerifiedPurchase Boolean @default(false)

  // Resolution for ratio-based enforcement
  resolution  ShopReportResolution @default(PENDING)
  resolutionNote String? @db.Text
  pointsApplied Int @default(0)

  resolvedAt  DateTime?
  resolvedById Int?
  resolvedBy  User?           @relation("ShopReportResolvedBy", fields: [resolvedById], references: [id], onDelete: SetNull)

  createdAt   DateTime        @default(now())

  @@index([shopId])
  @@index([reporterId])
  @@index([status])
  @@index([createdAt])
}

model ReviewReport {
  id         Int              @id @default(autoincrement())
  reviewId   Int
  review     Review           @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  reporterId Int
  reporter   User             @relation("ReviewReportsByUser", fields: [reporterId], references: [id], onDelete: Cascade)
  reason     String
  status     ReviewReportStatus @default(OPEN)
  createdAt  DateTime @default(now())
  resolvedAt DateTime?

  @@index([reviewId])
  @@index([reporterId])
  @@index([status])
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String
  title     String
  body      String?
  dataJson  String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
}

model AuditLog {
  id          Int      @id @default(autoincrement())
  actorId     Int?
  actor       User?    @relation("AuditActor", fields: [actorId], references: [id], onDelete: SetNull)
  action      String
  entityType  String
  entityId    String?
  metadataJson String?
  createdAt   DateTime @default(now())

  @@index([actorId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
}

model Setting {
  key       String   @id
  valueJson String
  updatedAt DateTime @default(now()) @updatedAt
}
